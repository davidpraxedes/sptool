// MBWay Payment - Com Polling Real
(function () {
    'use strict';

    // Elementos
    const statusTitle = document.querySelector('.status-title');
    const statusSubtitle = document.querySelector('.status-subtitle');
    const timerDisplay = document.getElementById('timer');
    const loadingIndicator = document.querySelector('.loading-indicator');

    // Obter transaction ID da URL
    const urlParams = new URLSearchParams(window.location.search);
    const transactionId = urlParams.get('tx');

    // Recuperar dados do sessionStorage
    const paymentData = JSON.parse(sessionStorage.getItem('currentPayment') || '{}');
    const userEmail = sessionStorage.getItem('userEmail');

    console.log('ðŸ”„ PÃ¡gina MB WAY carregada');
    console.log('Transaction ID:', transactionId);
    console.log('Payment Data:', paymentData);

    // Timer de 5 minutos
    let timeLeft = 300; // 5 minutos em segundos

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        if (timeLeft <= 0) {
            // Tempo esgotado
            showExpired();
            return;
        }

        timeLeft--;
    }

    // Atualizar timer a cada segundo
    const timerInterval = setInterval(updateTimer, 1000);

    // FunÃ§Ã£o para mostrar sucesso
    function showSuccess() {
        clearInterval(timerInterval);
        clearInterval(pollInterval);

        statusTitle.textContent = 'âœ… Pagamento Confirmado!';
        statusSubtitle.textContent = 'ReceberÃ¡s o acesso por email em instantes';
        statusTitle.style.color = '#10B981';

        // Esconder loading
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }

        // Redirecionar para success apÃ³s 2 segundos
        setTimeout(() => {
            window.location.href = './success.html';
        }, 2000);
    }

    // FunÃ§Ã£o para mostrar expirado
    function showExpired() {
        clearInterval(timerInterval);
        clearInterval(pollInterval);

        statusTitle.textContent = 'â±ï¸ Tempo Esgotado';
        statusSubtitle.textContent = 'Por favor, tenta novamente';
        statusTitle.style.color = '#EF4444';

        // Esconder loading
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }

        // Redirecionar para checkout apÃ³s 3 segundos
        setTimeout(() => {
            window.location.href = './checkout.html';
        }, 3000);
    }

    // FunÃ§Ã£o para mostrar erro
    function showError() {
        clearInterval(timerInterval);
        clearInterval(pollInterval);

        statusTitle.textContent = 'âŒ Pagamento Falhou';
        statusSubtitle.textContent = 'Ocorreu um erro. Tenta novamente.';
        statusTitle.style.color = '#EF4444';

        // Esconder loading
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }

        // Redirecionar para checkout apÃ³s 3 segundos
        setTimeout(() => {
            window.location.href = './checkout.html';
        }, 3000);
    }

    // Iniciar polling se temos transaction ID
    let pollInterval;

    if (transactionId) {
        console.log('ðŸ”„ Iniciando polling de status...');

        pollInterval = WayMBService.startPolling(transactionId, (status) => {
            console.log('ðŸ“Š Status atualizado:', status);

            if (status.status === 'COMPLETED' || status.status === 'PAID') {
                console.log('âœ… Pagamento confirmado!');
                showSuccess();
            } else if (status.status === 'FAILED') {
                console.log('âŒ Pagamento falhou');
                showError();
            } else if (status.status === 'EXPIRED') {
                console.log('â±ï¸ Pagamento expirou');
                showExpired();
            }
        });
    } else {
        console.error('âŒ Transaction ID nÃ£o encontrado!');
        showError();
    }

    // Limpar intervalos ao sair da pÃ¡gina
    window.addEventListener('beforeunload', () => {
        if (timerInterval) clearInterval(timerInterval);
        if (pollInterval) clearInterval(pollInterval);
    });

})();
