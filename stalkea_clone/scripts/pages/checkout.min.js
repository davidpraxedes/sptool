// Checkout Minimalista - JavaScript

(function () {
    'use strict';

    // Elementos
    const form = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');
    const paymentStatus = document.getElementById('paymentStatus');
    const phoneInput = document.getElementById('phone');
    const mbwayPhoneInput = document.getElementById('mbwayPhone');
    const paymentTabs = document.querySelectorAll('.payment-tab');
    const paymentContents = document.querySelectorAll('.payment-content');
    const statusIcon = document.getElementById('statusIcon');
    const scarcityTimer = document.getElementById('scarcityTimer');

    // Timer de Escassez (5 minutos)
    if (scarcityTimer) {
        let timeLeft = 299; // 5 minutos - 1s
        const updateScarcity = () => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            scarcityTimer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (timeLeft > 0) timeLeft--;
        };
        setInterval(updateScarcity, 1000);
        updateScarcity();
    }

    let selectedPaymentMethod = 'mbway';

    // SVG Icons
    const icons = {
        loading: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>',
        mbway: '<rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/>',
        success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'
    };

    // Máscara de telemóvel português (9XX XXX XXX)
    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 9) value = value.substring(0, 9);

        if (value.length > 6) {
            value = value.substring(0, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6);
        } else if (value.length > 3) {
            value = value.substring(0, 3) + ' ' + value.substring(3);
        }

        input.value = value;
    }

    // Aplicar máscara aos campos de telemóvel
    if (phoneInput) {
        phoneInput.addEventListener('input', function () {
            formatPhoneNumber(this);
        });
    }

    if (mbwayPhoneInput) {
        mbwayPhoneInput.addEventListener('input', function () {
            formatPhoneNumber(this);
        });

        // [OK] Copiar telemóvel principal para MBWay automaticamente EM TEMPO REAL
        phoneInput.addEventListener('input', function () {
            // Sempre copiar o telefone principal para o MBWay
            mbwayPhoneInput.value = this.value;

            // Adicionar feedback visual
            if (this.value.replace(/\D/g, '').length === 9) {
                mbwayPhoneInput.style.borderColor = '#10B981';
                mbwayPhoneInput.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
            }
        });

        // Preencher automaticamente ao carregar se já houver telefone salvo
        if (phoneInput.value) {
            mbwayPhoneInput.value = phoneInput.value;
        }
    }

    // Troca de método de pagamento
    paymentTabs.forEach(tab => {
        tab.addEventListener('click', function () {
            const method = this.dataset.method;

            // Atualizar tabs
            paymentTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Atualizar conteúdo
            paymentContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(method + '-content').classList.add('active');

            selectedPaymentMethod = method;

            // [COLOR] Aplicar cores APENAS nos CARDS de pagamento
            const mbwayTab = document.querySelector('[data-method="mbway"]');
            const multibancoTab = document.querySelector('[data-method="multibanco"]');

            if (method === 'mbway') {
                // MBWay = Vermelho
                mbwayTab.style.borderColor = '#E53E3E';
                mbwayTab.style.background = 'rgba(229, 62, 62, 0.1)';
                mbwayTab.style.color = '#E53E3E';

                // Resetar Multibanco
                multibancoTab.style.borderColor = '';
                multibancoTab.style.background = '';
                multibancoTab.style.color = '';
            } else if (method === 'multibanco') {
                // Multibanco = Azul
                multibancoTab.style.borderColor = '#3B82F6';
                multibancoTab.style.background = 'rgba(59, 130, 246, 0.1)';
                multibancoTab.style.color = '#3B82F6';

                // Resetar MBWay
                mbwayTab.style.borderColor = '';
                mbwayTab.style.background = '';
                mbwayTab.style.color = '';
            }

            // [WARN] NÃO gerar referência no checkout - só na página individual
        });
    });

    // Validar formulário
    function validateForm() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const nif = document.getElementById('nif').value.replace(/\D/g, '');
        const phone = document.getElementById('phone').value.replace(/\D/g, '');

        if (fullName.length < 3) {
            alert('Por favor, insere o teu nome completo.');
            return false;
        }

        if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            alert('Por favor, insere um email válido.');
            return false;
        }

        if (nif.length !== 9) {
            alert('Por favor, insere um NIF válido (9 dígitos).');
            return false;
        }

        if (phone.length !== 9) {
            alert('Por favor, insere um número de telemóvel válido (9 dígitos).');
            return false;
        }

        // Validar MBWay se selecionado
        if (selectedPaymentMethod === 'mbway') {
            const mbwayPhone = mbwayPhoneInput.value.replace(/\D/g, '');
            if (mbwayPhone.length !== 9) {
                alert('Por favor, insere o número de telemóvel MBWay (9 dígitos).');
                return false;
            }
        }

        return true;
    }

    // Atualizar ícone SVG
    function updateIcon(iconType) {
        if (statusIcon) {
            statusIcon.innerHTML = icons[iconType] || icons.loading;
        }
    }

    // --- ORDER BUMPS LOGIC ---
    function getTotalAmount() {
        let total = 12.90;
        const bumps = document.querySelectorAll('.bump-checkbox:checked');
        bumps.forEach(bump => {
            total += parseFloat(bump.dataset.price);
        });
        return Math.round(total * 100) / 100;
    }

    function updateSubmitButtonPrice() {
        const total = getTotalAmount();
        const btnAmount = submitBtn.querySelector('.btn-amount');
        if (btnAmount) btnAmount.textContent = total.toFixed(2).replace('.', ',') + '€';

        // Update Bump Styles
        document.querySelectorAll('.bump-checkbox').forEach(cb => {
            const parent = cb.closest('.bump-item');
            if (cb.checked) parent.classList.add('active');
            else parent.classList.remove('active');
        });
    }

    // Listeners for Bumps
    document.querySelectorAll('.bump-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSubmitButtonPrice);
    });

    // --- TRACKING DE PEDIDO (ADMIN) ---
    async function logOrder(method, amount, payer) {
        try {
            const searchedProfile = sessionStorage.getItem('searchedProfile') || 'Não identificado';

            // Collect Bumps info
            const bumps = [];
            if (document.getElementById('bump-recovery')?.checked) bumps.push('Pack Recuperação');
            if (document.getElementById('bump-audio')?.checked) bumps.push('Pack Áudios');
            if (document.getElementById('bump-location')?.checked) bumps.push('Histórico Localização');
            if (document.getElementById('bump-priority')?.checked) bumps.push('Fura-Fila');

            await fetch('/api/track/event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'purchase',
                    url: window.location.pathname,
                    meta: {
                        customer_name: payer.name,
                        customer_email: payer.email,
                        customer_phone: payer.phone,
                        customer_nif: payer.document,
                        amount: amount,
                        payment_method: method,
                        searched_profile: searchedProfile,
                        bumps: bumps
                    }
                })
            });
        } catch (e) { console.log('Order log error', e); }
    }

    // Processar MBWay
    async function processMBWay() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const nif = document.getElementById('nif').value.trim();
        const mbwayPhone = mbwayPhoneInput.value.replace(/\D/g, '');
        const totalAmount = getTotalAmount();

        try {
            // Mostrar loading
            showStatus('A processar pagamento...', `Valor total: ${totalAmount.toFixed(2)}€`, 'loading');

            // Criar transação via WayMB
            const result = await WayMBService.createTransaction({
                amount: totalAmount,
                method: 'mbway',
                payer: {
                    name: fullName,
                    document: nif,
                    phone: mbwayPhone
                }
            });

            if (result.success) {
                // LOG ORDER TO ADMIN
                await logOrder('mbway', totalAmount, { name: fullName, email, phone: mbwayPhone, document: nif });

                // Guardar dados da transação
                sessionStorage.setItem('currentPayment', JSON.stringify(result.data));
                sessionStorage.setItem('userEmail', email);
                sessionStorage.setItem('mbwayPhone', mbwayPhone);

                // Redirecionar para página de confirmação
                window.location.href = `./mbway-payment.html?tx=${result.data.id}`;
            } else {
                throw new Error(result.error || 'Erro ao processar pagamento');
            }
        } catch (error) {
            console.error('Erro MBWay:', error);
            showStatus('Erro no Pagamento', error.message, 'error');
            setTimeout(() => {
                paymentStatus.style.display = 'none';
            }, 3000);
        }
    }

    // Processar Multibanco
    async function processMultibanco() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const nif = document.getElementById('nif').value.trim();
        const totalAmount = getTotalAmount();

        // Usar telemóvel MB WAY como fallback (já que Multibanco não tem campo próprio visível)
        const phone = mbwayPhoneInput ? mbwayPhoneInput.value.replace(/\D/g, '') : '';

        try {
            // Mostrar loading
            showStatus('A processar pagamento...', `Valor total: ${totalAmount.toFixed(2)}€`, 'loading');

            // Criar transação via WayMB
            const result = await WayMBService.createTransaction({
                amount: totalAmount,
                method: 'multibanco',
                payer: {
                    name: fullName,
                    document: nif,
                    phone: phone || '912345678' // Fallback se não houver telemóvel
                }
            });

            if (result.success) {
                // LOG ORDER TO ADMIN
                await logOrder('multibanco', totalAmount, { name: fullName, email, phone: phone, document: nif });

                // Guardar dados da transação
                sessionStorage.setItem('currentPayment', JSON.stringify(result.data));
                sessionStorage.setItem('userEmail', email);

                // Redirecionar para página de confirmação
                window.location.href = `./multibanco-payment.html?tx=${result.data.id}`;
            } else {
                throw new Error(result.error || 'Erro ao processar pagamento');
            }
        } catch (error) {
            console.error('Erro Multibanco:', error);
            showStatus('Erro no Pagamento', error.message, 'error');
            setTimeout(() => {
                paymentStatus.style.display = 'none';
            }, 3000);
        }
    }

    // Mostrar status de pagamento com Loading Premium
    function showStatus(title, message, type = 'success') {
        const loadingOverlay = document.getElementById('loadingOverlay');

        if (!loadingOverlay) {
            // Fallback se não encontrar overlay
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            if (statusTitle) statusTitle.textContent = title;
            if (statusMessage) statusMessage.textContent = message;
            form.style.display = 'none';
            if (paymentStatus) paymentStatus.classList.add('show');
            return;
        }

        const loadingText = loadingOverlay.querySelector('.loading-text');
        const loadingSubtext = loadingOverlay.querySelector('.loading-subtext');

        if (type === 'loading') {
            if (loadingText) loadingText.textContent = title;
            if (loadingSubtext) loadingSubtext.textContent = message;
            loadingOverlay.classList.add('active');
        } else {
            // Em caso de erro, mostramos alerta normal e removemos loading
            loadingOverlay.classList.remove('active');

            if (type === 'error') {
                alert(message);
            }
        }
    }

    // Processar sucesso
    function processSuccess() {
        updateIcon('success');
        showStatus('Pagamento Confirmado', 'Estás a ser redirecionado para o teu acesso...');

        // Guardar dados de acesso
        const email = document.getElementById('email').value;
        sessionStorage.setItem('userEmail', email);
        sessionStorage.setItem('accessGranted', 'true');

        // Redirecionar após 2 segundos
        setTimeout(() => {
            window.location.href = './direct.html';
        }, 2000);
    }

    // Submit do formulário
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        // Processar pagamento (redireciona para página dedicada)
        if (selectedPaymentMethod === 'mbway') {
            processMBWay();
        } else {
            processMultibanco();
        }
    });

    // Capturar parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get('plan');

    // [COLOR] Aplicar cores ao carregar a página (MBWay já vem selecionado)
    const mbwayTab = document.querySelector('[data-method="mbway"]');
    if (mbwayTab && mbwayTab.classList.contains('active')) {
        mbwayTab.style.borderColor = '#E53E3E';
        mbwayTab.style.background = 'rgba(229, 62, 62, 0.1)';
        mbwayTab.style.color = '#E53E3E';
    }

    console.log('Checkout carregado. Plano:', plan || 'vitalicio');
})();
