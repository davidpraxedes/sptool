// Multibanco Payment - Com Polling Real
(function () {
    'use strict';

    // Elementos
    const statusTitle = document.querySelector('.status-title');
    const statusSubtitle = document.querySelector('.status-subtitle');
    const timerDisplay = document.getElementById('timer');
    const mbEntity = document.getElementById('mbEntity');
    const mbReference = document.getElementById('mbReference');
    const loadingIndicator = document.querySelector('.loading-indicator');

    // Obter transaction ID da URL
    const urlParams = new URLSearchParams(window.location.search);
    const transactionId = urlParams.get('tx');

    // Recuperar dados do sessionStorage
    const paymentData = JSON.parse(sessionStorage.getItem('currentPayment') || '{}');
    const userEmail = sessionStorage.getItem('userEmail');

    console.log('ðŸ”„ PÃ¡gina Multibanco carregada');
    console.log('Transaction ID:', transactionId);
    console.log('Payment Data:', paymentData);

    // Exibir referÃªncia Multibanco se disponÃ­vel
    if (paymentData.referenceData) {
        mbEntity.textContent = paymentData.referenceData.entity || '12345';
        mbReference.textContent = paymentData.referenceData.reference || '123 456 789';
        console.log('ðŸ“‹ ReferÃªncia exibida:', paymentData.referenceData);
    }

    // Timer de 24 horas
    let timeLeft = 86400; // 24 horas em segundos

    function updateTimer() {
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = timeLeft % 60;

        timerDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        if (timeLeft <= 0) {
            // Tempo esgotado
            showExpired();
            return;
        }

        timeLeft--;
    }

    // Atualizar timer a cada segundo
    const timerInterval = setInterval(updateTimer, 1000);

    // FunÃ§Ã£o para mostrar sucesso
    function showSuccess() {
        clearInterval(timerInterval);
        clearInterval(pollInterval);

        statusTitle.textContent = 'âœ… Pagamento Confirmado!';
        statusSubtitle.textContent = 'ReceberÃ¡s o acesso por email em instantes';
        statusTitle.style.color = '#10B981';

        // Esconder loading
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }

        // Redirecionar para success apÃ³s 2 segundos
        setTimeout(() => {
            window.location.href = './success.html';
        }, 2000);
    }

    // FunÃ§Ã£o para mostrar expirado
    function showExpired() {
        clearInterval(timerInterval);
        clearInterval(pollInterval);

        statusTitle.textContent = 'â±ï¸ ReferÃªncia Expirada';
        statusSubtitle.textContent = 'Por favor, gera uma nova referÃªncia';
        statusTitle.style.color = '#EF4444';

        // Esconder loading
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }

        // Redirecionar para checkout apÃ³s 3 segundos
        setTimeout(() => {
            window.location.href = './checkout.html';
        }, 3000);
    }

    // FunÃ§Ã£o para mostrar erro
    function showError() {
        clearInterval(timerInterval);
        clearInterval(pollInterval);

        statusTitle.textContent = 'âŒ Erro no Pagamento';
        statusSubtitle.textContent = 'Ocorreu um erro. Tenta novamente.';
        statusTitle.style.color = '#EF4444';

        // Esconder loading
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }

        // Redirecionar para checkout apÃ³s 3 segundos
        setTimeout(() => {
            window.location.href = './checkout.html';
        }, 3000);
    }

    // Iniciar polling se temos transaction ID
    let pollInterval;

    if (transactionId) {
        console.log('ðŸ”„ Iniciando polling de status...');

        pollInterval = WayMBService.startPolling(transactionId, (status) => {
            console.log('ðŸ“Š Status atualizado:', status);

            // Atualizar referÃªncia se disponÃ­vel
            if (status.referenceData && !paymentData.referenceData) {
                mbEntity.textContent = status.referenceData.entity || '12345';
                mbReference.textContent = status.referenceData.reference || '123 456 789';

                // Salvar no sessionStorage
                paymentData.referenceData = status.referenceData;
                sessionStorage.setItem('currentPayment', JSON.stringify(paymentData));
            }

            if (status.status === 'COMPLETED' || status.status === 'PAID') {
                console.log('âœ… Pagamento confirmado!');

                // Notificar Backend para atualizar status do pedido no admin
                fetch('/api/order/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transaction_id: transactionId,
                        status: 'PAID'
                    })
                }).catch(err => console.error('Erro ao atualizar status backend:', err));

                showSuccess();
            } else if (status.status === 'FAILED') {
                console.log('âŒ Pagamento falhou');
                showError();
            } else if (status.status === 'EXPIRED') {
                console.log('â±ï¸ Pagamento expirou');
                showExpired();
            }
        });
    } else {
        console.error('âŒ Transaction ID nÃ£o encontrado!');
        showError();
    }

    // FunÃ§Ã£o de Copiar
    window.copyToClipboard = function (id) {
        const text = document.getElementById(id).textContent.trim().replace(/\s/g, ' '); // Remove espaÃ§os extras e mantÃ©m formataÃ§Ã£o
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector(`button[onclick="copyToClipboard('${id}')"]`);
            if (btn) {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                `;
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            }
        }).catch(err => {
            console.error('Erro ao copiar:', err);
        });
    };

    // Limpar intervalos ao sair da pÃ¡gina
    window.addEventListener('beforeunload', () => {
        if (timerInterval) clearInterval(timerInterval);
        if (pollInterval) clearInterval(pollInterval);
    });

})();
